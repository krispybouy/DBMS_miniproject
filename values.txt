-- ============================================
-- SIDRAMA - MOVIE & TV SHOW REVIEW DATABASE
-- Based on Your Schema with Optional Enhancements
-- ============================================

-- Create Database
CREATE DATABASE IF NOT EXISTS sidrama;
USE sidrama;

-- ============================================
-- TABLE DEFINITIONS
-- ============================================

-- 1. User Table
CREATE TABLE User (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    dob DATE,
    email VARCHAR(100) NOT NULL UNIQUE,
    ph_no VARCHAR(20),
    address VARCHAR(255)
    
    -- OPTIONAL: Add creation timestamp
    -- , created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    
    -- OPTIONAL: Add last login tracking
    -- , last_login TIMESTAMP NULL
);

-- 2. Movie Table
CREATE TABLE Movie (
    movie_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    total_duration INT,
    descr TEXT,
    box_office BIGINT,
    release_date DATE,
    age_rating VARCHAR(10),
    language VARCHAR(50),
    ratings DECIMAL(3,2) DEFAULT 0.00,
    poster_url VARCHAR(500),
    total_reviews INT DEFAULT 0
);

-- 3. Show Table (TV Shows)
CREATE TABLE tvshow (
    show_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    num_of_seasons INT,
    num_of_episodes INT,
    descr TEXT,
    release_date DATE,
    age_rating VARCHAR(10),
    language VARCHAR(50),
    ratings DECIMAL(3,2) DEFAULT 0.00,    
    poster_url VARCHAR(500),
    status VARCHAR(20) DEFAULT 'Ongoing' -- 'Ongoing', 'Completed', 'Cancelled'
);

-- 4. Episode Table
CREATE TABLE Episode (
    episode_id INT PRIMARY KEY AUTO_INCREMENT,
    show_id INT NOT NULL,
    season_number INT,
    episode_no INT,
    ep_descr TEXT,
    duration INT,
    air_date DATE,
    FOREIGN KEY (show_id) REFERENCES tvshow (show_id) ON DELETE CASCADE,
    title VARCHAR(255)
);

-- 5. Review Table
CREATE TABLE Review (
    review_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    movie_id INT,
    episode_id INT,
    date DATE,
    rating DECIMAL(2,1) CHECK (rating >= 0 AND rating <= 5),
    review_text TEXT,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (episode_id) REFERENCES Episode(episode_id) ON DELETE CASCADE,
    likes_count INT DEFAULT 0,
    UNIQUE KEY unique_user_episode (user_id, episode_id),
    CHECK ((movie_id IS NOT NULL AND episode_id IS NULL) OR (movie_id IS NULL AND episode_id IS NOT NULL))
);

-- 6. Genre Table
CREATE TABLE Genre (
    genre_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
);

-- 7. Actor Table
CREATE TABLE Actor (
    actor_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    dob DATE,
    gender VARCHAR(10),
    bio TEXT,
    profile_image_url VARCHAR(500)
);

-- 8. Director Table
CREATE TABLE Director (
    director_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    dob DATE,
    gender VARCHAR(10),
    bio TEXT,
    profile_image_url VARCHAR(500),
    nationality VARCHAR(50)
);

-- 9. Movie_Director (Many-to-Many)
CREATE TABLE Movie_Director (
    movie_id INT NOT NULL,
    director_id INT NOT NULL,
    PRIMARY KEY (movie_id, director_id),
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (director_id) REFERENCES Director(director_id) ON DELETE CASCADE
);

-- 10. Movie_Actor (Many-to-Many)
CREATE TABLE Movie_Actor (
    movie_id INT NOT NULL,
    actor_id INT NOT NULL,
    PRIMARY KEY (movie_id, actor_id),
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (actor_id) REFERENCES Actor(actor_id) ON DELETE CASCADE,
    character_name VARCHAR(100)
);

-- 11. Movie_Genre (Many-to-Many)
CREATE TABLE Movie_Genre (
    movie_id INT NOT NULL,
    genre_id INT NOT NULL,
    PRIMARY KEY (movie_id, genre_id),
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (genre_id) REFERENCES Genre(genre_id) ON DELETE CASCADE
);

-- 12. Show_Genre (Many-to-Many)
CREATE TABLE Show_Genre (
    show_id INT NOT NULL,
    genre_id INT NOT NULL,
    PRIMARY KEY (show_id, genre_id),
    FOREIGN KEY (show_id) REFERENCES tvshow(show_id) ON DELETE CASCADE,
    FOREIGN KEY (genre_id) REFERENCES Genre(genre_id) ON DELETE CASCADE
);


-- OPTIONAL: Watchlist Table (for users to save movies/shows to watch later)
/*
CREATE TABLE Watchlist (
    watchlist_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    movie_id INT,
    show_id INT,
    added_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    watched BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (show_id) REFERENCES tvshow(show_id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_movie (user_id, movie_id),
    UNIQUE KEY unique_user_show (user_id, show_id),
    CHECK ((movie_id IS NOT NULL AND show_id IS NULL) OR (movie_id IS NULL AND show_id IS NOT NULL))
);
*/

-- OPTIONAL: User Lists (custom lists like "My Favorite Thrillers")
/*
CREATE TABLE User_List (
    list_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    list_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_public BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE
);

CREATE TABLE List_Items (
    list_item_id INT PRIMARY KEY AUTO_INCREMENT,
    list_id INT NOT NULL,
    movie_id INT,
    show_id INT,
    added_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (list_id) REFERENCES User_List(list_id) ON DELETE CASCADE,
    FOREIGN KEY (movie_id) REFERENCES Movie(movie_id) ON DELETE CASCADE,
    FOREIGN KEY (show_id) REFERENCES tvshow(show_id) ON DELETE CASCADE
);
*/

-- OPTIONAL: Review Likes (users can like reviews)
/*
CREATE TABLE Review_Likes (
    like_id INT PRIMARY KEY AUTO_INCREMENT,
    review_id INT NOT NULL,
    user_id INT NOT NULL,
    liked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (review_id) REFERENCES Review(review_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES User(user_id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_review_like (user_id, review_id)
);

CREATE TABLE User_Followers (
    follower_id INT NOT NULL,
    following_id INT NOT NULL,
    followed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (follower_id, following_id),
    FOREIGN KEY (follower_id) REFERENCES User(user_id) ON DELETE CASCADE,
    FOREIGN KEY (following_id) REFERENCES User(user_id) ON DELETE CASCADE,
    CHECK (follower_id != following_id)
);
*/


-- ============================================
-- VIEWS
-- ============================================

-- View 1: All Movie Reviews with User Details
CREATE VIEW movie_reviews_view AS
SELECT 
    r.review_id,
    u.username,
    u.name AS user_name,
    m.name AS movie_name,
    r.rating,
    r.review_text,
    r.date AS review_date
FROM Review r
JOIN User u ON r.user_id = u.user_id
JOIN Movie m ON r.movie_id = m.movie_id
WHERE r.movie_id IS NOT NULL;

-- View 2: Popular Movies with Average Ratings
CREATE VIEW popular_movies AS
SELECT 
    m.movie_id,
    m.name,
    m.release_date,
    m.language,
    m.age_rating,
    COUNT(r.review_id) AS total_reviews,
    AVG(r.rating) AS avg_rating
FROM Movie m
LEFT JOIN Review r ON m.movie_id = r.movie_id
GROUP BY m.movie_id, m.name, m.release_date, m.language, m.age_rating
HAVING total_reviews > 0
ORDER BY avg_rating DESC;

-- View 3: TV Show Episode Reviews
CREATE VIEW episode_reviews_view AS
SELECT 
    r.review_id,
    u.username,
    s.name AS show_name,
    e.season_number,
    e.episode_no,
    r.rating,
    r.review_text,
    r.date AS review_date
FROM Review r
JOIN User u ON r.user_id = u.user_id
JOIN Episode e ON r.episode_id = e.episode_id
JOIN `Show` s ON e.show_id = s.show_id
WHERE r.episode_id IS NOT NULL;

-- View 4: Movies with Genres and Directors
CREATE VIEW movie_details_view AS
SELECT 
    m.movie_id,
    m.name AS movie_name,
    m.release_date,
    m.total_duration,
    m.ratings,
    GROUP_CONCAT(DISTINCT g.name SEPARATOR ', ') AS genres,
    GROUP_CONCAT(DISTINCT d.name SEPARATOR ', ') AS directors
FROM Movie m
LEFT JOIN Movie_Genre mg ON m.movie_id = mg.movie_id
LEFT JOIN Genre g ON mg.genre_id = g.genre_id
LEFT JOIN Movie_Director md ON m.movie_id = md.movie_id
LEFT JOIN Director d ON md.director_id = d.director_id
GROUP BY m.movie_id, m.name, m.release_date, m.total_duration, m.ratings;


CREATE VIEW user_stats_view AS
SELECT 
    u.user_id,
    u.username,
    u.name,
    COUNT(DISTINCT r.review_id) AS total_reviews,
    AVG(r.rating) AS avg_rating_given,
    COUNT(DISTINCT CASE WHEN r.movie_id IS NOT NULL THEN r.movie_id END) AS movies_reviewed,
    COUNT(DISTINCT CASE WHEN r.episode_id IS NOT NULL THEN r.episode_id END) AS episodes_reviewed
FROM User u
LEFT JOIN Review r ON u.user_id = r.user_id
GROUP BY u.user_id, u.username, u.name;


-- OPTIONAL VIEW: Top rated shows

CREATE VIEW top_rated_shows AS
SELECT 
    s.show_id,
    s.name,
    s.num_of_seasons,
    s.ratings,
    COUNT(DISTINCT e.episode_id) AS total_episodes,
    COUNT(DISTINCT r.review_id) AS total_reviews
FROM `Show` s
LEFT JOIN Episode e ON s.show_id = e.show_id
LEFT JOIN Review r ON e.episode_id = r.episode_id
GROUP BY s.show_id, s.name, s.num_of_seasons, s.ratings
HAVING total_reviews > 0
ORDER BY s.ratings DESC;


-- ============================================
-- TRIGGERS
-- ============================================

-- Trigger 1: Update Movie Rating After Review Insert
DELIMITER //
CREATE TRIGGER update_movie_rating_insert
AFTER INSERT ON Review
FOR EACH ROW
BEGIN
    IF NEW.movie_id IS NOT NULL THEN
        UPDATE Movie
        SET ratings = (
            SELECT AVG(rating)
            FROM Review
            WHERE movie_id = NEW.movie_id
        )
        WHERE movie_id = NEW.movie_id;
        
        -- OPTIONAL: Also update total_reviews count (if column exists)
        -- UPDATE Movie
        -- SET total_reviews = (
        --     SELECT COUNT(*)
        --     FROM Review
        --     WHERE movie_id = NEW.movie_id
        -- )
        -- WHERE movie_id = NEW.movie_id;
    END IF;
END//
DELIMITER ;

-- Trigger 2: Update Movie Rating After Review Update
DELIMITER //
CREATE TRIGGER update_movie_rating_update
AFTER UPDATE ON Review
FOR EACH ROW
BEGIN
    IF NEW.movie_id IS NOT NULL THEN
        UPDATE Movie
        SET ratings = (
            SELECT AVG(rating)
            FROM Review
            WHERE movie_id = NEW.movie_id
        )
        WHERE movie_id = NEW.movie_id;
    END IF;
END//
DELIMITER ;

-- Trigger 3: Update Movie Rating After Review Delete
DELIMITER //
CREATE TRIGGER update_movie_rating_delete
AFTER DELETE ON Review
FOR EACH ROW
BEGIN
    IF OLD.movie_id IS NOT NULL THEN
        UPDATE Movie
        SET ratings = COALESCE((
            SELECT AVG(rating)
            FROM Review
            WHERE movie_id = OLD.movie_id
        ), 0.00)
        WHERE movie_id = OLD.movie_id;
        
        -- OPTIONAL: Also update total_reviews count (if column exists)
        -- UPDATE Movie
        -- SET total_reviews = (
        --     SELECT COUNT(*)
        --     FROM Review
        --     WHERE movie_id = OLD.movie_id
        -- )
        -- WHERE movie_id = OLD.movie_id;
    END IF;
END//
DELIMITER ;

-- Trigger 4: Update Show Rating After Episode Review
DELIMITER //
CREATE TRIGGER update_show_rating
AFTER INSERT ON Review
FOR EACH ROW
BEGIN
    IF NEW.episode_id IS NOT NULL THEN
        UPDATE `Show` s
        SET s.ratings = (
            SELECT AVG(r.rating)
            FROM Review r
            JOIN Episode e ON r.episode_id = e.episode_id
            WHERE e.show_id = (
                SELECT show_id FROM Episode WHERE episode_id = NEW.episode_id
            )
        )
        WHERE s.show_id = (
            SELECT show_id FROM Episode WHERE episode_id = NEW.episode_id
        );
    END IF;
END//
DELIMITER ;

-- OPTIONAL TRIGGER: Prevent reviewing both movie and episode in same review

DELIMITER //
CREATE TRIGGER check_review_type
BEFORE INSERT ON Review
FOR EACH ROW
BEGIN
    IF (NEW.movie_id IS NOT NULL AND NEW.episode_id IS NOT NULL) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'A review cannot be for both a movie and an episode';
    END IF;
    
    IF (NEW.movie_id IS NULL AND NEW.episode_id IS NULL) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'A review must be for either a movie or an episode';
    END IF;
END//
DELIMITER ;


-- OPTIONAL TRIGGER: Auto-set review date if not provided

DELIMITER //
CREATE TRIGGER set_review_date
BEFORE INSERT ON Review
FOR EACH ROW
BEGIN
    IF NEW.date IS NULL THEN
        SET NEW.date = CURDATE();
    END IF;
END//
DELIMITER ;


-- OPTIONAL TRIGGER: Update review likes count (if Review_Likes table exists)

DELIMITER //
CREATE TRIGGER update_review_likes_insert
AFTER INSERT ON Review_Likes
FOR EACH ROW
BEGIN
    UPDATE Review
    SET likes_count = likes_count + 1
    WHERE review_id = NEW.review_id;
END//
DELIMITER ;

CREATE TRIGGER update_review_likes_delete
AFTER DELETE ON Review_Likes
FOR EACH ROW
BEGIN
    UPDATE Review
    SET likes_count = likes_count - 1
    WHERE review_id = OLD.review_id;
END//
DELIMITER ;


-- ============================================
-- STORED PROCEDURES
-- ============================================

-- Procedure 1: Add Movie Review
DELIMITER //
CREATE PROCEDURE add_movie_review(
    IN p_user_id INT,
    IN p_movie_id INT,
    IN p_rating DECIMAL(2,1),
    IN p_review_text TEXT
)
BEGIN
    -- OPTIONAL: Add error handling
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'Error: Review could not be added' AS error_message;
    END;
    
    START TRANSACTION;
    INSERT INTO Review (user_id, movie_id, date, rating, review_text)
    VALUES (p_user_id, p_movie_id, CURDATE(), p_rating, p_review_text);
    COMMIT;
    
    SELECT 'Review added successfully' AS message;
END//
DELIMITER ;

-- Procedure 2: Get User's All Reviews
DELIMITER //
CREATE PROCEDURE get_user_reviews(IN p_user_id INT)
BEGIN
    SELECT 
        r.review_id,
        COALESCE(m.name, s.name) AS content_name,
        CASE 
            WHEN r.movie_id IS NOT NULL THEN 'Movie'
            ELSE 'TV Show'
        END AS content_type,
        r.rating,
        r.review_text,
        r.date
    FROM Review r
    LEFT JOIN Movie m ON r.movie_id = m.movie_id
    LEFT JOIN Episode e ON r.episode_id = e.episode_id
    LEFT JOIN `Show` s ON e.show_id = s.show_id
    WHERE r.user_id = p_user_id
    ORDER BY r.date DESC;
END//
DELIMITER ;

-- Procedure 3: Search Movies by Genre
DELIMITER //
CREATE PROCEDURE search_movies_by_genre(IN p_genre_name VARCHAR(100))
BEGIN
    SELECT 
        m.movie_id,
        m.name,
        m.release_date,
        m.ratings,
        m.language
    FROM Movie m
    JOIN Movie_Genre mg ON m.movie_id = mg.movie_id
    JOIN Genre g ON mg.genre_id = g.genre_id
    WHERE g.name = p_genre_name
    ORDER BY m.ratings DESC;
END//
DELIMITER ;

-- Procedure 4: Get Movies by Director
DELIMITER //
CREATE PROCEDURE get_movies_by_director(IN p_director_name VARCHAR(100))
BEGIN
    SELECT 
        m.movie_id,
        m.name,
        m.release_date,
        m.ratings,
        d.name AS director_name
    FROM Movie m
    JOIN Movie_Director md ON m.movie_id = md.movie_id
    JOIN Director d ON md.director_id = d.director_id
    WHERE d.name LIKE CONCAT('%', p_director_name, '%')
    ORDER BY m.release_date DESC;
END//
DELIMITER ;

-- Procedure 5: Get Movies by Actor
DELIMITER //
CREATE PROCEDURE get_movies_by_actor(IN p_actor_name VARCHAR(100))
BEGIN
    SELECT 
        m.movie_id,
        m.name,
        m.release_date,
        m.ratings,
        a.name AS actor_name
    FROM Movie m
    JOIN Movie_Actor ma ON m.movie_id = ma.movie_id
    JOIN Actor a ON ma.actor_id = a.actor_id
    WHERE a.name LIKE CONCAT('%', p_actor_name, '%')
    ORDER BY m.release_date DESC;
END//
DELIMITER ;

-- Procedure 6: Get Show Details with Episodes
DELIMITER //
CREATE PROCEDURE get_show_details(IN p_show_id INT)
BEGIN
    -- Show basic info
    SELECT * FROM `Show` WHERE show_id = p_show_id;
    
    -- All episodes
    SELECT 
        episode_id,
        season_number,
        episode_no,
        ep_descr,
        duration,
        air_date
    FROM Episode
    WHERE show_id = p_show_id
    ORDER BY season_number, episode_no;
END//
DELIMITER ;

-- OPTIONAL PROCEDURE: Delete user and all related data

DELIMITER //
CREATE PROCEDURE delete_user(IN p_user_id INT)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'Error: User could not be deleted' AS error_message;
    END;
    
    START TRANSACTION;
    DELETE FROM User WHERE user_id = p_user_id;
    COMMIT;
    
    SELECT 'User deleted successfully (cascade handled all related data)' AS message;
END//
DELIMITER ;


-- OPTIONAL PROCEDURE: Search movies by multiple criteria

DELIMITER //
CREATE PROCEDURE advanced_movie_search(
    IN p_title VARCHAR(255),
    IN p_genre VARCHAR(100),
    IN p_min_rating DECIMAL(3,2),
    IN p_language VARCHAR(50)
)
BEGIN
    SELECT DISTINCT
        m.movie_id,
        m.name,
        m.release_date,
        m.ratings,
        m.language
    FROM Movie m
    LEFT JOIN Movie_Genre mg ON m.movie_id = mg.movie_id
    LEFT JOIN Genre g ON mg.genre_id = g.genre_id
    WHERE (p_title IS NULL OR m.name LIKE CONCAT('%', p_title, '%'))
      AND (p_genre IS NULL OR g.name = p_genre)
      AND (p_min_rating IS NULL OR m.ratings >= p_min_rating)
      AND (p_language IS NULL OR m.language = p_language)
    ORDER BY m.ratings DESC, m.release_date DESC
    LIMIT 50;
END//
DELIMITER ;


-- ============================================
-- FUNCTIONS
-- ============================================

-- Function 1: Get User's Average Rating
DELIMITER //
CREATE FUNCTION get_user_avg_rating(p_user_id INT)
RETURNS DECIMAL(3,2)
DETERMINISTIC
BEGIN
    DECLARE avg_rating DECIMAL(3,2);
    
    SELECT COALESCE(AVG(rating), 0.00) INTO avg_rating
    FROM Review
    WHERE user_id = p_user_id;
    
    RETURN avg_rating;
END//
DELIMITER ;

-- Function 2: Count User Reviews
DELIMITER //
CREATE FUNCTION count_user_reviews(p_user_id INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE review_count INT;
    
    SELECT COUNT(*) INTO review_count
    FROM Review
    WHERE user_id = p_user_id;
    
    RETURN review_count;
END//
DELIMITER ;

-- Function 3: Check if User Reviewed Movie
DELIMITER //
CREATE FUNCTION has_reviewed_movie(p_user_id INT, p_movie_id INT)
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE reviewed BOOLEAN;
    
    SELECT EXISTS(
        SELECT 1 FROM Review 
        WHERE user_id = p_user_id AND movie_id = p_movie_id
    ) INTO reviewed;
    
    RETURN reviewed;
END//
DELIMITER ;

-- OPTIONAL FUNCTION: Calculate movie popularity score (mix of rating and review count)

DELIMITER //
CREATE FUNCTION calculate_movie_popularity(p_movie_id INT)
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE popularity DECIMAL(5,2);
    DECLARE avg_rating DECIMAL(3,2);
    DECLARE review_count INT;
    
    SELECT COALESCE(m.ratings, 0), COUNT(r.review_id)
    INTO avg_rating, review_count
    FROM Movie m
    LEFT JOIN Review r ON m.movie_id = r.movie_id
    WHERE m.movie_id = p_movie_id
    GROUP BY m.movie_id, m.ratings;
    
    -- Popularity = (avg_rating * 0.7) + (log(review_count + 1) * 0.3)
    SET popularity = (avg_rating * 0.7) + (LOG10(review_count + 1) * 0.3);
    
    RETURN COALESCE(popularity, 0.00);
END//
DELIMITER ;


-- OPTIONAL FUNCTION: Get total movies reviewed by user

DELIMITER //
CREATE FUNCTION count_movies_reviewed(p_user_id INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE movie_count INT;
    
    SELECT COUNT(DISTINCT movie_id) INTO movie_count
    FROM Review
    WHERE user_id = p_user_id AND movie_id IS NOT NULL;
    
    RETURN COALESCE(movie_count, 0);
END//
DELIMITER ;

-- ============================================
-- SAMPLE DATA
-- ============================================

-- Insert Genres
INSERT INTO Genre (name) VALUES
('Action'), ('Drama'), ('Comedy'), ('Sci-Fi'), ('Thriller'),
('Horror'), ('Romance'), ('Crime'), ('Fantasy'), ('Animation');

-- Insert Directors
INSERT INTO Director (name, dob, gender, bio) VALUES
('Christopher Nolan', '1970-07-30', 'Male', 'British-American filmmaker known for complex narratives'),
('Quentin Tarantino', '1963-03-27', 'Male', 'American filmmaker known for nonlinear storylines'),
('Martin Scorsese', '1942-11-17', 'Male', 'American director known for crime films'),
('Steven Spielberg', '1946-12-18', 'Male', 'Legendary American director and producer'),
('Greta Gerwig', '1983-08-04', 'Female', 'American actress and filmmaker');

-- Insert Actors
INSERT INTO Actor (name, dob, gender, bio) VALUES
('Leonardo DiCaprio', '1974-11-11', 'Male', 'American actor and film producer'),
('Tom Hanks', '1956-07-09', 'Male', 'American actor and filmmaker'),
('Scarlett Johansson', '1984-11-22', 'Female', 'American actress and singer'),
('Robert Downey Jr.', '1965-04-04', 'Male', 'American actor and producer'),
('Morgan Freeman', '1937-06-01', 'Male', 'American actor and narrator'),
('Meryl Streep', '1949-06-22', 'Female', 'American actress with record Oscar nominations'),
('Denzel Washington', '1954-12-28', 'Male', 'American actor and director');

-- Insert Movies
INSERT INTO Movie (name, total_duration, descr, box_office, release_date, age_rating, language, ratings) VALUES
('Inception', 148, 'A thief who steals corporate secrets through dream-sharing technology', 829895144, '2010-07-16', 'PG-13', 'English', 0),
('The Shawshank Redemption', 142, 'Two imprisoned men bond over years finding solace and redemption', 28341469, '1994-09-23', 'R', 'English', 0),
('The Dark Knight', 152, 'Batman faces the Joker in a battle for Gotham City', 1004558444, '2008-07-18', 'PG-13', 'English', 0),
('Pulp Fiction', 154, 'Various interconnected stories of LA crime underworld', 213928762, '1994-10-14', 'R', 'English', 0),
('Forrest Gump', 142, 'Life story of a simple man who witnesses historical events', 678226465, '1994-07-06', 'PG-13', 'English', 0),
('The Matrix', 136, 'A hacker discovers reality is a computer simulation', 467222728, '1999-03-31', 'R', 'English', 0),
('Interstellar', 169, 'A team of explorers travel through a wormhole in space', 677471339, '2014-11-07', 'PG-13', 'English', 0);

-- Insert TV Shows
INSERT INTO `Show` (name, num_of_seasons, num_of_episodes, descr, release_date, age_rating, language, ratings) VALUES
('Breaking Bad', 5, 62, 'A chemistry teacher turns to cooking methamphetamine', '2008-01-20', 'TV-MA', 'English', 0),
('Game of Thrones', 8, 73, 'Nine noble families fight for control of the Iron Throne', '2011-04-17', 'TV-MA', 'English', 0),
('Stranger Things', 4, 34, 'Kids in a small town face supernatural forces from another dimension', '2016-07-15', 'TV-14', 'English', 0),
('The Office', 9, 201, 'A mockumentary about office employees at a paper company', '2005-03-24', 'TV-14', 'English', 0);

-- Insert Episodes (sample for each show)
INSERT INTO Episode (show_id, season_number, episode_no, ep_descr, duration, air_date) VALUES
-- Breaking Bad
(1, 1, 1, 'Walter White is diagnosed with cancer and turns to cooking meth', 58, '2008-01-20'),
(1, 1, 2, 'Walt and Jesse dispose of the bodies and clean up the RV', 48, '2008-01-27'),
(1, 1, 3, '...And the Bag''s in the River', 48, '2008-02-10'),
-- Game of Thrones
(2, 1, 1, 'Winter is Coming - Ned Stark is asked to be Hand of the King', 62, '2011-04-17'),
(2, 1, 2, 'The Kingsroad - The Lannisters plot to ensure Bran''s silence', 56, '2011-04-24'),
-- Stranger Things
(3, 1, 1, 'The Vanishing of Will Byers', 47, '2016-07-15'),
(3, 1, 2, 'The Weirdo on Maple Street', 55, '2016-07-15'),
-- The Office
(4, 1, 1, 'Pilot - Introduction to Dunder Mifflin', 22, '2005-03-24'),
(4, 1, 2, 'Diversity Day', 22, '2005-03-29');

-- Insert Users
INSERT INTO User (username, password, name, dob, email, ph_no, address) VALUES
('john_doe', '$2b$12$hash1', 'John Doe', '1995-05-15', 'john@email.com', '9876543210', '123 Main St, New York'),
('jane_smith', '$2b$12$hash2', 'Jane Smith', '1998-08-22', 'jane@email.com', '9876543211', '456 Oak Ave, Los Angeles'),
('movie_buff', '$2b$12$hash3', 'Mike Johnson', '1992-03-10', 'mike@email.com', '9876543212', '789 Pine Rd, Chicago'),
('cinephile_99', '$2b$12$hash4', 'Sarah Williams', '1990-12-05', 'sarah@email.com', '9876543213', '321 Elm St, Boston'),
('tv_fan_2024', '$2b$12$hash5', 'Alex Chen', '2000-07-18', 'alex@email.com', '9876543214', '654 Maple Dr, Seattle');

-- Link Movies to Directors
INSERT INTO Movie_Director (movie_id, director_id) VALUES
(1, 1), -- Inception - Nolan
(3, 1), -- Dark Knight - Nolan
(7, 1), -- Interstellar - Nolan
(2, 3), -- Shawshank - (let's say Scorsese for demo)
(4, 2); -- Pulp Fiction - Tarantino

-- Link Movies to Actors
INSERT INTO Movie_Actor (movie_id, actor_id) VALUES
(1, 1), -- Inception - DiCaprio
(3, 1), -- Dark Knight - DiCaprio (demo)
(2, 5), -- Shawshank - Freeman
(5, 2), -- Forrest Gump - Hanks
(7, 1); -- Interstellar - DiCaprio

-- Link Movies to Genres
INSERT INTO Movie_Genre (movie_id, genre_id) VALUES
(1, 4), (1, 1), (1, 5), -- Inception: Sci-Fi, Action, Thriller
(2, 2), -- Shawshank: Drama
(3, 1), (3, 5), (3, 8), -- Dark Knight: Action, Thriller, Crime
(4, 8), (4, 5), -- Pulp Fiction: Crime, Thriller
(5, 2), (5, 7), -- Forrest Gump: Drama, Romance
(6, 4), (6, 1), -- Matrix: Sci-Fi, Action
(7, 4), (7, 2); -- Interstellar: Sci-Fi, Drama

-- Link Shows to Genres
INSERT INTO Show_Genre (show_id, genre_id) VALUES
(1, 2), (1, 8), (1, 5), -- Breaking Bad: Drama, Crime, Thriller
(2, 9), (2, 2), (2, 1), -- GoT: Fantasy, Drama, Action
(3, 4), (3, 6), (3, 5), -- Stranger Things: Sci-Fi, Horror, Thriller
(4, 3); -- The Office: Comedy

-- Insert Reviews
INSERT INTO Review (user_id, movie_id, episode_id, date, rating, review_text) VALUES
-- Movie Reviews
(1, 1, NULL, '2024-01-15', 5.0, 'Mind-bending masterpiece! Nolan at his absolute best. The dream sequences are brilliantly executed.'),
(1, 2, NULL, '2024-01-20', 5.0, 'One of the greatest films ever made. A timeless story about hope, friendship, and redemption.'),
(2, 1, NULL, '2024-02-10', 4.5, 'Complex and engaging narrative. Needs multiple viewings to fully appreciate all the layers.'),
(2, 3, NULL, '2024-02-15', 5.0, 'Heath Ledger is absolutely phenomenal as the Joker. Oscar-worthy performance.'),
(3, 4, NULL, '2024-03-01', 4.5, 'Tarantino dialogue perfection. Non-linear storytelling that keeps you hooked.'),
(3, 5, NULL, '2024-03-05', 4.0, 'Heartwarming and inspiring. Tom Hanks delivers an unforgettable performance.'),
(4, 1, NULL, '2024-03-10', 4.5, 'Visually stunning with a thought-provoking plot. The ending is debated to this day.'),
(4, 6, NULL, '2024-03-15', 5.0, 'Revolutionary film that changed sci-fi action movies forever. The bullet-time effect is iconic.'),
(5, 7, NULL, '2024-03-20', 4.5, 'Epic space journey with stunning visuals and emotional depth. Nolan''s best work alongside Inception.'),
-- TV Episode Reviews
(1, NULL, 1, '2024-03-25', 5.0, 'Perfect pilot episode. Immediately hooks you into Walter White''s transformation.'),
(2, NULL, 4, '2024-04-01', 4.5, 'Excellent start to Game of Thrones. Sets up the complex world and politics brilliantly.'),
(3, NULL, 6, '2024-04-05', 5.0, 'Stranger Things pilot is one of the best I''ve seen. Captures 80s nostalgia perfectly.'),
(4, NULL, 8, '2024-04-10', 4.0, 'The Office pilot is awkward but shows promise. Michael Scott is hilariously cringe.'),
(5, NULL, 2, '2024-04-15', 4.5, 'Breaking Bad gets darker and more intense. Jesse and Walt''s chemistry develops.');

-- ============================================
-- EXAMPLE QUERIES (All Types of Joins)
-- ============================================

-- Query 1: INNER JOIN - Movies with their Directors
SELECT 
    m.name AS movie_name,
    d.name AS director_name,
    m.release_date,
    m.ratings
FROM Movie m
INNER JOIN Movie_Director md ON m.movie_id = md.movie_id
INNER JOIN Director d ON md.director_id = d.director_id
ORDER BY m.release_date DESC;

-- Query 2: LEFT JOIN - All Movies with Review Count (including movies with no reviews)
SELECT 
    m.name AS movie_name,
    m.ratings AS current_rating,
    m.release_date,
    COUNT(r.review_id) AS total_reviews,
    COALESCE(AVG(r.rating), 0) AS avg_user_rating
FROM Movie m
LEFT JOIN Review r ON m.movie_id = r.movie_id
GROUP BY m.movie_id, m.name, m.ratings, m.release_date
ORDER BY total_reviews DESC;

-- Query 3: RIGHT JOIN - All Reviews with Movie Info
SELECT 
    u.username,
    m.name AS movie_name,
    r.rating,
    r.review_text,
    r.date
FROM Movie m
RIGHT JOIN Review r ON m.movie_id = r.movie_id
JOIN User u ON r.user_id = u.user_id
WHERE r.movie_id IS NOT NULL;

-- Query 4: SELF JOIN - Users who reviewed same movies (find users with similar taste)
SELECT DISTINCT
    u1.username AS user1,
    u2.username AS user2,
    m.name AS movie_name,
    r1.rating AS user1_rating,
    r2.rating AS user2_rating
FROM Review r1
JOIN Review r2 ON r1.movie_id = r2.movie_id AND r1.user_id < r2.user_id
JOIN User u1 ON r1.user_id = u1.user_id
JOIN User u2 ON r2.user_id = u2.user_id
JOIN Movie m ON r1.movie_id = m.movie_id
WHERE r1.movie_id IS NOT NULL
ORDER BY m.name;

-- Query 5: MULTIPLE JOINS - Movies with Genres, Directors, and Actors
SELECT 
    m.name AS movie_name,
    m.release_date,
    m.ratings,
    GROUP_CONCAT(DISTINCT g.name ORDER BY g.name SEPARATOR ', ') AS genres,
    GROUP_CONCAT(DISTINCT d.name ORDER BY d.name SEPARATOR ', ') AS directors,
    GROUP_CONCAT(DISTINCT a.name ORDER BY a.name SEPARATOR ', ') AS actors
FROM Movie m
LEFT JOIN Movie_Genre mg ON m.movie_id = mg.movie_id
LEFT JOIN Genre g ON mg.genre_id = g.genre_id
LEFT JOIN Movie_Director md ON m.movie_id = md.movie_id
LEFT JOIN Director d ON md.director_id = d.director_id
LEFT JOIN Movie_Actor ma ON m.movie_id = ma.movie_id
LEFT JOIN Actor a ON ma.actor_id = a.actor_id
GROUP BY m.movie_id, m.name, m.release_date, m.ratings
ORDER BY m.name;

-- Query 6: Complex Join - Shows with Episode Reviews and User Info
SELECT 
    s.name AS show_name,
    e.season_number,
    e.episode_no,
    u.username,
    r.rating,
    r.review_text,
    r.date
FROM `Show` s
JOIN Episode e ON s.show_id = e.show_id
LEFT JOIN Review r ON e.episode_id = r.episode_id
LEFT JOIN User u ON r.user_id = u.user_id
ORDER BY s.show_id, e.season_number, e.episode_no;

-- Query 7: CROSS JOIN Example - All possible User-Genre combinations (for recommendations)
-- (Be careful with CROSS JOIN on large datasets)
SELECT 
    u.username,
    g.name AS genre
FROM User u
CROSS JOIN Genre g
LIMIT 20;

-- Query 8: Complex Aggregation - Top Rated Movies by Genre
SELECT 
    g.name AS genre,
    m.name AS movie_name,
    m.ratings,
    COUNT(r.review_id) AS review_count
FROM Genre g
JOIN Movie_Genre mg ON g.genre_id = mg.genre_id
JOIN Movie m ON mg.movie_id = m.movie_id
LEFT JOIN Review r ON m.movie_id = r.movie_id
GROUP BY g.genre_id, g.name, m.movie_id, m.name, m.ratings
HAVING review_count > 0
ORDER BY g.name, m.ratings DESC;

-- ============================================
-- TEST QUERIES FOR PROCEDURES AND FUNCTIONS
-- ============================================

-- Test Stored Procedures
CALL add_movie_review(1, 6, 5.0, 'The Matrix revolutionized action cinema!');
CALL get_user_reviews(1);
CALL search_movies_by_genre('Action');
CALL get_movies_by_director('Nolan');
CALL get_movies_by_actor('DiCaprio');
CALL get_show_details(1);

-- Test Functions
SELECT get_user_avg_rating(1) AS avg_rating;
SELECT count_user_reviews(1) AS total_reviews;
SELECT has_reviewed_movie(1, 1) AS has_reviewed;
SELECT has_reviewed_movie(1, 7) AS has_not_reviewed;

-- Test Views
SELECT * FROM movie_reviews_view;
SELECT * FROM popular_movies;
SELECT * FROM episode_reviews_view;
SELECT * FROM movie_details_view;

-- ============================================
-- USEFUL ADMIN QUERIES
-- ============================================

-- Show all tables
SHOW TABLES;

-- Describe table structure
-- DESC User;
-- DESC Movie;
-- DESC Review;

-- Show all triggers
-- SHOW TRIGGERS;

-- Show all procedures
-- SHOW PROCEDURE STATUS WHERE Db = 'sidrama';

-- Show all functions
-- SHOW FUNCTION STATUS WHERE Db = 'sidrama';

-- Show all views
-- SHOW FULL TABLES WHERE TABLE_TYPE LIKE 'VIEW';

-- ============================================
-- END OF SCRIPT
-- ============================================
